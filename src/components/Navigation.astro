---
import MenuIcon from "../assets/images/menu.svg";
import CtaButton from "../components/CtaButton.astro";
import LogoSvg from "../assets/images/logo.svg";

// `disabled` is optional; when true, the item is rendered non-interactive
const links = [
  { name: "Forside", href: "/" },
  { name: "Se billett", href: "/billett" },
  { name: "Booking", href: "/booking" },
  { name: "Program", href: "/program" },
  { name: "Heiskort", href: "https://sogndal.skiperformance.com/no/shopp#/no/buy?is_promo=1&is_promo_offer=0&promo_connector_id=8" },
];

const ticketLink = { name: "Kjøp billett", href: "https://tikkio.com/events/60480" };
const currentPath = Astro.url?.pathname || "/";
---

<header id="site-header" class="fixed top-0 left-0 w-full z-50">
  <div class="promo-bar" data-promo-bar>
    <div class="promo-bar__inner">
      <span class="promo-bar__dot" aria-hidden="true"></span>
      <span>
        Bestill heiskort nå! Bruk koden <strong>sogn2d</strong> ved bestilling for å få Ski &amp; Magi pris.
      </span>
      <button type="button" class="promo-bar__close" data-promo-close aria-label="Lukk varsel">×</button>
    </div>
  </div>
  <nav id="site-nav" class="px-8 lg:px-16 py-4 text-white transition-colors">
    <div class="flex items-center justify-between w-full mx-auto">
      <!-- Logo -->
      <a href="/" draggable="false" class="flex items-center gap-2 nav-logo">
        <LogoSvg class="w-auto h-9" />
        <span class="sr-only">Ski & Magi</span>
      </a>

      <!-- Desktop Menu -->
      <div class="items-center hidden gap-6 text-nowrap font-medium md:flex">
        {
          links.map((l) =>
            l.disabled ? (
              <span aria-disabled="true" class="relative opacity-60 cursor-default select-none">
                {l.name}
              </span>
            ) : (
              <a
                href={l.href}
                target={l.href.startsWith("http") ? "_blank" : undefined}
                rel={l.href.startsWith("http") ? "noreferrer" : undefined}
                class={`relative transition-colors duration-300 hover:opacity-90 ${currentPath === l.href ? "font-semibold after:absolute after:-bottom-1.5 after:left-0 after:w-full after:h-0.5 after:bg-linear-to-r after:from-sky-400 after:to-fuchsia-400 after:rounded-full" : ""}`}
              >
                {l.name}
              </a>
            )
          )
        }

        <!-- CTA Button (enabled, matches CtaSection style) -->
        <CtaButton label={ticketLink.name} href={ticketLink.href} newTab class="px-5 py-2 ml-4 rounded-full text-sm hover:translate-y-0" />
      </div>

      <!-- Mobile CTA + Menu Button -->
      <div class="flex items-center gap-3 md:hidden">
        <CtaButton label={ticketLink.name} href={ticketLink.href} class="px-4 py-2 text-sm whitespace-nowrap hover:translate-y-0" />
        <button type="button" data-menu-btn class="flex items-center hover:cursor-pointer hover:opacity-90 focus:outline-none" aria-label="Åpne meny">
          <MenuIcon class="w-6 h-6" />
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div data-mobile_menu data-mobile-menu id="mobile-nav-menu" class="text-nowrap flex-col py-5 space-y-5 md:hidden">
      {
        links.map((l) =>
          l.disabled ? (
            <span aria-disabled="true" class="block font-medium opacity-50 cursor-default select-none">
              {l.name}
            </span>
          ) : (
            <a
              href={l.href}
              target={l.href.startsWith("http") ? "_blank" : undefined}
              rel={l.href.startsWith("http") ? "noreferrer" : undefined}
              class={`block font-medium transition-colors ${currentPath === l.href ? "font-semibold" : "opacity-80 hover:opacity-100"}`}
            >
              {l.name}
            </a>
          )
        )
      }
      <!-- CTA moved into the top bar on mobile -->
    </div>
  </nav>
</header>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const nav = document.getElementById("site-nav");
    if (!nav) return;

    const promoBar = document.querySelector("[data-promo-bar]");
    const promoClose = document.querySelector("[data-promo-close]");
    if (promoClose && promoBar) {
      promoClose.addEventListener("click", () => {
        promoBar.classList.add("promo-bar--dismissed");
        window.setTimeout(() => {
          promoBar.setAttribute("hidden", "");
        }, 300);
      });
    }

    const btn = nav.querySelector("[data-menu-btn]");
    const menu = nav.querySelector("[data-mobile_menu],[data-mobile-menu]") || nav.querySelector("[data-mobile-menu]");
    if (btn && menu) {
      // a11y
      btn.setAttribute("aria-controls", "mobile-nav-menu");
      btn.setAttribute("aria-expanded", "false");

      const toggleMenu = () => {
        const isOpen = menu.classList.toggle("open");
        btn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        // Stretch nav overlays to cover dropdown height
        if (isOpen) {
          const h = menu.scrollHeight;
          nav.classList.add("menu-open");
          nav.style.setProperty("--menu-h", h + "px");
        } else {
          nav.classList.remove("menu-open");
          nav.style.setProperty("--menu-h", "0px");
        }
      };
      btn.addEventListener("click", toggleMenu);
    }

    // Constants
    const THEME_DARK = "#0b0f1a"; // over hero
    const THEME_LIGHT = "#ffffff"; // past hero (light surface)
    const OFFSET_Y = 50; // early switch before bottom of hero hits nav

    // Only enable scroll-based tone change on the index page
    const isHome = location.pathname === "/" || location.pathname === "/index.html";
    if (isHome) {
      const hero = document.querySelector(".hero") || document.getElementById("hero") || document.querySelector("section.hero");
      const navH = nav.offsetHeight || 64;

      const setThemeColor = (hex) => {
        const tags = document.querySelectorAll('meta[name="theme-color"]');
        tags.forEach((m) => m.setAttribute("content", hex));
      };

      const updateTone = () => {
        if (!hero) return;
        const rect = hero.getBoundingClientRect();
        const pastHero = rect.bottom <= navH + OFFSET_Y;
        nav.classList.toggle("past-hero", pastHero);
        setThemeColor(pastHero ? THEME_LIGHT : THEME_DARK);
      };

      updateTone();
      window.addEventListener("scroll", updateTone, { passive: true });
      window.addEventListener("resize", updateTone);
    }
  });
</script>

<style is:global>
  .promo-bar {
    width: 100%;
    padding: 0.5rem 1rem;
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.25), rgba(14, 116, 144, 0.25), rgba(59, 130, 246, 0.25));
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
    animation: promo-slide-in 320ms ease-out;
    transition:
      transform 260ms ease,
      opacity 260ms ease;
  }

  .promo-bar::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0));
    transform: translateX(-100%);
    animation: promo-shimmer 3.5s ease-in-out infinite;
    pointer-events: none;
  }

  .promo-bar--dismissed {
    transform: translateY(-100%);
    opacity: 0;
  }

  .promo-bar__inner {
    max-width: 64rem;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    position: relative;
    padding-right: 2.5rem;
    padding-left: 2.5rem;
    color: #fff;
    font-size: 0.8rem;
    text-align: center;
  }

  .promo-bar__inner strong {
    font-weight: 700;
    letter-spacing: 0.04em;
  }

  .promo-bar__dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 9999px;
    background: #34d399;
    box-shadow: 0 0 8px rgba(52, 211, 153, 0.7);
    flex: 0 0 auto;
    animation: promo-pulse 1.8s ease-in-out infinite;
  }

  .promo-bar__close {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    border: 0;
    background: transparent;
    color: #fff;
    font-size: 1.1rem;
    line-height: 1;
    opacity: 0.8;
    cursor: pointer;
  }

  .promo-bar__close:hover {
    opacity: 1;
  }

  @keyframes promo-pulse {
    0%,
    100% {
      transform: scale(1);
      box-shadow: 0 0 8px rgba(52, 211, 153, 0.7);
    }
    50% {
      transform: scale(1.15);
      box-shadow: 0 0 14px rgba(52, 211, 153, 0.9);
    }
  }

  @keyframes promo-shimmer {
    0% {
      transform: translateX(-100%);
    }
    50% {
      transform: translateX(100%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  @keyframes promo-slide-in {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @media (max-width: 640px) {
    .promo-bar__inner {
      font-size: 0.75rem;
      line-height: 1.2;
    }
  }

  /* Mobile menu animation */
  #site-nav [data-mobile-menu] {
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    z-index: 20;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px) scale(0.98);
    transition:
      opacity 0ms ease,
      visibility 0ms ease,
      transform 200ms ease;
    overflow: hidden;
    pointer-events: none;
    isolation: isolate; /* ensure ::before stays behind content */
    background: transparent;
    border: 0;
  }
  #site-nav [data-mobile-menu].open {
    position: static; /* allow header to expand with dropdown */
    left: auto;
    right: auto;
    top: auto;
    opacity: 1;
    visibility: visible;
    transform: none;
    pointer-events: auto;
  }

  /* Blur the actual dropdown element via its ID */
  #mobile-nav-menu {
    /* No inner background; rely on header glass */
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 0;
    border-radius: 0;
    box-shadow: none;
  }

  /* Header glass background (no pseudo elements) */
  #site-header {
    isolation: isolate;
    background: linear-gradient(120deg, rgba(59, 130, 246, 0.18), rgba(139, 92, 246, 0.16), rgba(236, 72, 153, 0.14)), rgba(17, 24, 39, 0.2);
    backdrop-filter: saturate(180%) blur(22px);
    -webkit-backdrop-filter: saturate(180%) blur(22px);
  }

  /* Nav text color (fixed, no scroll-based changes) */
  #site-nav,
  #site-nav a,
  #site-nav .nav-logo,
  #site-nav .cta-btn {
    color: #fff;
  }
  /* Logo primary (white parts) should follow nav tone */
  #site-nav .nav-logo .cls-1 {
    fill: #fff;
    transition: fill 300ms cubic-bezier(0.4, 0, 0.2, 1);
  }
  #site-nav .cta-btn {
    transition: color 300ms cubic-bezier(0.4, 0, 0.2, 1);
  }
  #site-nav {
    border-color: rgba(255, 255, 255, 0.2);
  }
</style>
